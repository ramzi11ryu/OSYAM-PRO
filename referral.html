<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙØ±ÙŠÙ‚ÙŠ VP</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f0f0f,#1a1a1a,#000);
  color:#fff;
}
.header{
  padding:20px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
  background:#000;
  color:#ffd700;
}
.container{ padding:20px; }
.card{
  background:rgba(255,255,255,0.05);
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.6);
}
.code-box{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1c1c1c;
  padding:10px 15px;
  border-radius:12px;
}
.copy-btn{
  background:#ffd700;
  border:none;
  padding:8px 15px;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="header">ğŸ‘¥ ÙØ±ÙŠÙ‚ÙŠ VP</div>

<div class="container">

  <div class="card">
    <h3>ğŸ”‘ Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ©</h3>
    <div class="code-box">
      <span id="userCode">---</span>
      <button onclick="copyCode()" class="copy-btn">Ù†Ø³Ø®</button>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ’° Ø±ØµÙŠØ¯Ùƒ</h3>
    <p id="userBalance">0 Ø¯Ø¬</p>
  </div>

  <div class="card">
    <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙŠÙ‚</h3>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: <span id="teamCount">0</span></p>
    <button class="copy-btn" onclick="calculateProfit()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
    <div id="profitResult"></div>
  </div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

/* ğŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBiQ4dHe4sbKDIrsyF8WdpjV3sY4qAxU4E",
  authDomain: "osim-d1821.firebaseapp.com",
  projectId: "osim-d1821",
  storageBucket: "osim-d1821.firebasestorage.app",
  messagingSenderId: "464951343183",
  appId: "1:464951343183:web:21c7615a90e4f38385923a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
let teamMembers = [];

const userCode = document.getElementById("userCode");
const userBalance = document.getElementById("userBalance");
const teamCount = document.getElementById("teamCount");
const profitResult = document.getElementById("profitResult");

/* ğŸ”¹ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¹Ø´ÙˆØ§Ø¦ÙŠ */
function generateRefCode(){
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for(let i=0;i<8;i++){
    code += chars.charAt(Math.floor(Math.random()*chars.length));
  }
  return code;
}

/* ğŸ”¹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
onAuthStateChanged(auth, async (user)=>{

  if(!user){
    console.log("âš  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„");
    return;
  }

  currentUserId = user.uid;

  const userRef = doc(db,"users",currentUserId);
  const userSnap = await getDoc(userRef);

  if(userSnap.exists()){
    const data = userSnap.data();

    /* ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¥Ø°Ø§ Ù…Ø§ÙƒØ§Ù†Ø´ */
    if(!data.shortRef){
      const newCode = generateRefCode();
      await updateDoc(userRef,{
        shortRef:newCode,
        balance:data.balance || 0,
        lastProfit:data.lastProfit || 0
      });
      userCode.textContent = newCode;
    }else{
      userCode.textContent = data.shortRef;
    }

    userBalance.textContent = (data.balance || 0) + " Ø¯Ø¬";
  }

  /* ğŸ”¹ Ø¬Ù„Ø¨ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ Ø­Ø³Ø¨ invite */
  const myCode = userCode.textContent;

  const q = query(
    collection(db,"users"),
    where("invite","==", myCode)  // Ø£ÙŠ Ø¹Ø¶Ùˆ Ø³Ø¬Ù„ Ø¨Ø±Ù…Ø²Ùƒ
  );

  const snap = await getDocs(q);

  teamMembers = [];
  snap.forEach(doc=>{
    teamMembers.push(doc.data());
  });

  teamCount.textContent = teamMembers.length;
});

/* Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² */
window.copyCode = function(){
  navigator.clipboard.writeText(userCode.textContent)
  .then(()=> alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²"));
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ²ÙŠØ§Ø¯ØªÙ‡Ø§ */
window.calculateProfit = async function(){

  let total = 0;
  const count = teamMembers.length;

  /* Ù…ÙƒØ§ÙØ£Ø© Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
  if(count >= 100) total += 4000;
  else if(count >= 50) total += 3000;
  else if(count >= 20) total += 1500;

  /* Ø¹Ù…ÙˆÙ„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ */
  teamMembers.forEach(member=>{
    const lvl = member.level || 0;
    if(lvl === 1) total += 1000;
    else if(lvl === 2) total += 5000;
    else if(lvl === 3) total += 10000;
  });

  const userRef = doc(db,"users",currentUserId);
  const userSnap = await getDoc(userRef);

  if(userSnap.exists()){
    const data = userSnap.data();
    const lastProfit = data.lastProfit || 0;

    if(total > lastProfit){
      const difference = total - lastProfit;
      const newBalance = (data.balance || 0) + difference;

      await updateDoc(userRef,{
        balance:newBalance,
        lastProfit:total
      });

      userBalance.textContent = newBalance + " Ø¯Ø¬";
      profitResult.innerHTML = `ğŸ’¸ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${difference} Ø¯Ø¬`;
    }else{
      profitResult.innerHTML = "âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø¨Ø§Ø­ Ø¬Ø¯ÙŠØ¯Ø©";
    }
  }
}

</script>

</body>
</html>